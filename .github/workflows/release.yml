# GitHub Actions workflow for building and releasing Flutter APKs and IPAs.
#
# This workflow is triggered on every push to the 'release' branch.
# It automatically increments the version number based on the commit message,
# builds a signed APK and an unsigned IPA, and creates a new
# GitHub Release with both files.
#
name: Build and Release APK and IPA

on:
  push:
    branches:
      - release

jobs:
  version-bump:
    # Prevent workflow from running in an infinite loop
    if: "!contains(github.event.head_commit.message, 'ci: Bump version')"
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required to commit version changes.
    outputs:
      new_version: ${{ steps.version-increment.outputs.new_version }}
      new_version_name: ${{ steps.version-increment.outputs.new_version_name }}
    steps:
      # Step 1: Check out the repository code.
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetches all history for version bumping.
          token: ${{ secrets.GITHUB_TOKEN }}

      # Step 2: Set up Flutter for version manipulation.
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      # Step 3: Determine Version Increment
      - name: Determine Version Increment
        id: version-increment-type
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if [[ "$COMMIT_MSG" == *"majorUpdate"* || "$COMMIT_MSG" == *"refactor:"* ]]; then
            echo "increment=major" >> $GITHUB_OUTPUT
          elif [[ "$COMMIT_MSG" == *"feat:"* || "$COMMIT_MSG" == *"feat(ci):"* ]]; then
            echo "increment=minor" >> $GITHUB_OUTPUT
          else
            echo "increment=patch" >> $GITHUB_OUTPUT
          fi

      # Step 4: Bump version
      - name: Bump version
        id: version-increment
        run: |
          CURRENT_VERSION=$(grep 'version: ' pubspec.yaml | sed 's/version: //')
          VERSION_PART=$(echo $CURRENT_VERSION | cut -d'+' -f1)
          BUILD_PART=$(echo $CURRENT_VERSION | cut -d'+' -f2)
          MAJOR=$(echo $VERSION_PART | cut -d'.' -f1)
          MINOR=$(echo $VERSION_PART | cut -d'.' -f2)
          PATCH=$(echo $VERSION_PART | cut -d'.' -f3)
          BUMP_TYPE=${{ steps.version-increment-type.outputs.increment }}
          if [[ "$BUMP_TYPE" == "major" ]]; then
            MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0; BUILD_PART=1
          elif [[ "$BUMP_TYPE" == "minor" ]]; then
            MINOR=$((MINOR + 1)); PATCH=0; BUILD_PART=1
          else # patch
            PATCH=$((PATCH + 1)); BUILD_PART=$((BUILD_PART + 1))
          fi
          NEW_VERSION_NAME="$MAJOR.$MINOR.$PATCH"
          NEW_VERSION="$NEW_VERSION_NAME+$BUILD_PART"
          echo "new_version=${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "new_version_name=${NEW_VERSION_NAME}" >> $GITHUB_OUTPUT
          sed -i "s/version: .*/version: $NEW_VERSION/" pubspec.yaml

      # Step 5: Commit version bump
      - name: Commit version bump
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add pubspec.yaml
          git commit -m "ci: Bump version to ${{ steps.version-increment.outputs.new_version }}"
          git push

  build-android:
    needs: version-bump
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: 'release' # Checkout the release branch to get the new version commit

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Decode Keystore and Create Properties File
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 --decode > android/app/release.jks
          echo "storeFile=release.jks" > android/key.properties
          echo "keyAlias=$KEY_ALIAS" >> android/key.properties
          echo "keyPassword=$KEY_PASSWORD" >> android/key.properties
          echo "storePassword=$STORE_PASSWORD" >> android/key.properties

      - name: Build signed release APK
        run: flutter build apk --release

      - name: Rename APK
        id: rename
        run: |
          NEW_NAME="fuelTracker-release-${{ needs.version-bump.outputs.new_version_name }}.apk"
          mv build/app/outputs/flutter-apk/app-release.apk "build/app/outputs/flutter-apk/$NEW_NAME"
          echo "apk_name=$NEW_NAME" >> $GITHUB_OUTPUT
          echo "apk_path=build/app/outputs/flutter-apk/$NEW_NAME" >> $GITHUB_OUTPUT

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: apk-artifact
          path: ${{ steps.rename.outputs.apk_path }}

  build-ios:
    needs: version-bump
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: 'release'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Build unsigned release IPA
        run: flutter build ipa --release --no-codesign

      - name: Rename IPA
        id: rename
        run: |
          NEW_NAME="fuelTracker-release-${{ needs.version-bump.outputs.new_version_name }}.ipa"
          mv build/ios/ipa/fueltracker.ipa "build/ios/ipa/$NEW_NAME"
          echo "ipa_name=$NEW_NAME" >> $GITHUB_OUTPUT
          echo "ipa_path=build/ios/ipa/$NEW_NAME" >> $GITHUB_OUTPUT

      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ipa-artifact
          path: ${{ steps.rename.outputs.ipa_path }}

  create-release:
    needs: [build-android, build-ios, version-bump]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download APK artifact
        uses: actions/download-artifact@v4
        with:
          name: apk-artifact
          path: artifacts/apk

      - name: Download IPA artifact
        uses: actions/download-artifact@v4
        with:
          name: ipa-artifact
          path: artifacts/ipa

      - name: Create Release and Upload Artifacts
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.version-bump.outputs.new_version }}
          name: "Release ${{ needs.version-bump.outputs.new_version_name }}"
          body: |
            Automated release for version ${{ needs.version-bump.outputs.new_version_name }}.
            - Release APK (signed)
            - Release IPA (unsigned)
          files: |
            artifacts/apk/*.apk
            artifacts/ipa/*.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

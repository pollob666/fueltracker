# GitHub Actions workflow for building and releasing Flutter APKs.
#
# This workflow is triggered on every push to the 'release' branch.
# It automatically increments the version number based on the commit message,
# builds a signed APK, and creates a new GitHub Release with the file.
# The version bump is only committed if the build and release are successful.
#
name: Build and Release APK

on:
  push:
    branches:
      - release

jobs:
  calculate-version:
    if: "!contains(github.event.head_commit.message, 'ci: Bump version')"
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.version-increment.outputs.new_version }}
      new_version_name: ${{ steps.version-increment.outputs.new_version_name }}
      new_build_number: ${{ steps.version-increment.outputs.new_build_number }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetches all history for version bumping.

      - name: Determine Version Increment
        id: version-increment-type
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if [[ "$COMMIT_MSG" == *"majorUpdate"* || "$COMMIT_MSG" == *"refactor:"* ]]; then
            echo "increment=major" >> $GITHUB_OUTPUT
          elif [[ "$COMMIT_MSG" == *"feat:"* || "$COMMIT_MSG" == *"feat(ci):"* ]]; then
            echo "increment=minor" >> $GITHUB_OUTPUT
          else
            echo "increment=patch" >> $GITHUB_OUTPUT
          fi

      - name: Calculate New Version
        id: version-increment
        run: |
          # FIX: Added ^ to match only the version at the start of the line
          CURRENT_VERSION=$(grep '^version: ' pubspec.yaml | sed 's/version: //')
          VERSION_PART=$(echo $CURRENT_VERSION | cut -d'+' -f1)
          BUILD_PART=$(echo $CURRENT_VERSION | cut -d'+' -f2)
          MAJOR=$(echo $VERSION_PART | cut -d'.' -f1)
          MINOR=$(echo $VERSION_PART | cut -d'.' -f2)
          PATCH=$(echo $VERSION_PART | cut -d'.' -f3)
          BUMP_TYPE=${{ steps.version-increment-type.outputs.increment }}
          if [[ "$BUMP_TYPE" == "major" ]]; then
            MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0; BUILD_PART=1
          elif [[ "$BUMP_TYPE" == "minor" ]]; then
            MINOR=$((MINOR + 1)); PATCH=0; BUILD_PART=1
          else # patch
            PATCH=$((PATCH + 1)); BUILD_PART=$((BUILD_PART + 1))
          fi
          NEW_VERSION_NAME="$MAJOR.$MINOR.$PATCH"
          NEW_BUILD_NUMBER="$BUILD_PART"
          NEW_VERSION="$NEW_VERSION_NAME+$NEW_BUILD_NUMBER"
          echo "new_version=${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "new_version_name=${NEW_VERSION_NAME}" >> $GITHUB_OUTPUT
          echo "new_build_number=${NEW_BUILD_NUMBER}" >> $GITHUB_OUTPUT

  build:
    needs: calculate-version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update pubspec.yaml for build
        run: |
          # FIX: Added ^ to ensure we only replace the root version key
          sed -i "s/^version: .*/version: ${{ needs.calculate-version.outputs.new_version }}/" pubspec.yaml

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install dependencies
        run: flutter pub get

      - name: Decode Keystore and Create Properties File
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 --decode > android/app/release.jks
          echo "storeFile=release.jks" > android/app/key.properties
          echo "keyAlias=$KEY_ALIAS" >> android/app/key.properties
          echo "keyPassword=$KEY_PASSWORD" >> android/app/key.properties
          echo "storePassword=$STORE_PASSWORD" >> android/app/key.properties

      - name: Build signed release APK
        run: |
          flutter build apk --release \
            --build-name ${{ needs.calculate-version.outputs.new_version_name }} \
            --build-number ${{ needs.calculate-version.outputs.new_build_number }}

      - name: Rename APK
        id: rename_apk
        run: |
          NEW_NAME="fuelTracker-android-release-${{ needs.calculate-version.outputs.new_version_name }}.apk"
          mv build/app/outputs/flutter-apk/app-release.apk "build/app/outputs/flutter-apk/$NEW_NAME"
          echo "artifact_path=build/app/outputs/flutter-apk/$NEW_NAME" >> $GITHUB_OUTPUT

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: apk-artifact
          path: ${{ steps.rename_apk.outputs.artifact_path }}

  create-release:
    needs: [build, calculate-version]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download APK artifact
        uses: actions/download-artifact@v4
        with:
          name: apk-artifact
          path: artifacts/apk

      - name: Create Release and Upload Artifacts
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.calculate-version.outputs.new_version }}
          name: "Release ${{ needs.calculate-version.outputs.new_version_name }}"
          body: |
            Automated release for version ${{ needs.calculate-version.outputs.new_version_name }}.
            - Release APK (signed)
          files: |
            artifacts/apk/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  commit-and-push-version-bump:
    needs: [calculate-version, create-release]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit version bump
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          # FIX: Added ^ to ensure we only replace the root version key
          sed -i "s/^version: .*/version: ${{ needs.calculate-version.outputs.new_version }}/" pubspec.yaml
          git add pubspec.yaml
          git commit -m "ci: Bump version to ${{ needs.calculate-version.outputs.new_version }}"
          git push